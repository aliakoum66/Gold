//@version=5
strategy("Multi-Timeframe Gold Strategy", overlay=true, 
         default_qty_type=strategy.fixed, 
         default_qty_value=1,
         initial_capital=10000,
         commission_type=strategy.commission.percent,
         commission_value=0.1)

// INPUT PARAMETERS
// Trend Detection
emaShortLen = input.int(20, "EMA Short", minval=1, group="Trend")
emaLongLen = input.int(50, "EMA Long", minval=1, group="Trend")

// Momentum
rsiLen = input.int(14, "RSI Length", minval=1, group="Momentum")
rsiOB = input.int(70, "RSI Overbought", minval=50, maxval=100, group="Momentum")
rsiOS = input.int(30, "RSI Oversold", minval=0, maxval=50, group="Momentum")

// Volatility
atrLen = input.int(14, "ATR Length", minval=1, group="Volatility")
atrMult = input.float(2.0, "ATR Multiplier", minval=0.1, group="Volatility")

// Risk Management
riskReward = input.float(2.0, "Risk:Reward Ratio", minval=0.5, group="Risk")

// INDICATOR CALCULATIONS
// Trend
emaShort = ta.ema(close, emaShortLen)
emaLong = ta.ema(close, emaLongLen)
trendUp = emaShort > emaLong
trendDown = emaShort < emaLong

// Momentum
rsi = ta.rsi(close, rsiLen)
rsiOversold = rsi < rsiOS
rsiOverbought = rsi > rsiOB
rsiNeutral = rsi >= rsiOS and rsi <= rsiOB

// Volatility
atr = ta.atr(atrLen)

// ENTRY CONDITIONS
// Long: Uptrend + RSI recovering from oversold + price above EMA
longCondition = trendUp and ta.crossover(rsi, rsiOS) and close > emaShort

// Short: Downtrend + RSI falling from overbought + price below EMA  
shortCondition = trendDown and ta.crossunder(rsi, rsiOB) and close < emaShort

// POSITION MANAGEMENT
var float longSL = na
var float longTP = na
var float shortSL = na
var float shortTP = na

// Calculate stops and targets on entry
if longCondition and strategy.position_size == 0
    longSL := close - (atr * atrMult)
    longTP := close + (atr * atrMult * riskReward)
    strategy.entry("Long", strategy.long)

if shortCondition and strategy.position_size == 0
    shortSL := close + (atr * atrMult)
    shortTP := close - (atr * atrMult * riskReward)
    strategy.entry("Short", strategy.short)

// EXIT MANAGEMENT - Price-based exits only
if strategy.position_size > 0
    strategy.exit("Long Exit", "Long", stop=longSL, limit=longTP)

if strategy.position_size < 0
    strategy.exit("Short Exit", "Short", stop=shortSL, limit=shortTP)

// VISUALIZATION
// Plot EMAs
plot(emaShort, "EMA Short", color=color.blue, linewidth=2)
plot(emaLong, "EMA Long", color=color.red, linewidth=2)

// Plot entry signals
plotshape(longCondition, "Long Signal", shape.triangleup, location.belowbar, color.green, size=size.small)
plotshape(shortCondition, "Short Signal", shape.triangledown, location.abovebar, color.red, size=size.small)

// Plot stops and targets for active positions
plot(strategy.position_size > 0 ? longSL : na, "Long SL", color.red, style=plot.style_linebr, linewidth=2)
plot(strategy.position_size > 0 ? longTP : na, "Long TP", color.green, style=plot.style_linebr, linewidth=2)
plot(strategy.position_size < 0 ? shortSL : na, "Short SL", color.red, style=plot.style_linebr, linewidth=2)
plot(strategy.position_size < 0 ? shortTP : na, "Short TP", color.green, style=plot.style_linebr, linewidth=2)

// Background coloring for trend
bgcolor(trendUp ? color.new(color.green, 95) : trendDown ? color.new(color.red, 95) : na)